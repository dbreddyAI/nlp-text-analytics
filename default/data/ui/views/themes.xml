<!--<dashboard hideEdit="true">--><form script="themes_bar.js" stylesheet="tabledatabar.css">
  <label>Themes</label>
  <init>
    <set token="topic_model_apply">
      <![CDATA[| fit TruncatedSVD k=$topic_k$ $textfield$_* ]]>
    </set>
    <set token="featurefield">SVD</set>
  </init>
  <search id="base_search">
    <query>
$master_search$
| cleantext textfield=$textfield$ base_type=lemma_pos mv=f $custom_stopwords$
| fit TFIDF $textfield$ max_features=$max_features$ ngram_range=$ngram$
| fit $topic_algo$ k=$topic_k$ $textfield$_* 
| fit $cluster_algo$ $clusters$ "$featurefield$_*"
| table cluster $textfield$
    </query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search base="base_search" id="counts">
    <query>
| eval "$textfield$" = split('$textfield$', " ")
| stats count BY "$textfield$" cluster
| sort cluster -count
| streamstats count AS clusterCount BY cluster
  </query>
  </search>
  <fieldset submitButton="true" autoRun="false">
    <input type="time" token="time">
      <label>Time Range</label>
      <default>
        <earliest>-1d@d</earliest>
        <latest>@d</latest>
      </default>
    </input>
    <input id="text_long" type="text" token="master_search">
      <label>Text Search</label>
      <default></default>
    </input>
    <html>
      <p/>
    </html>
    <input type="text" token="textfield">
      <label>Text Field</label>
    </input>
    <input id="text_medium" type="text" token="custom_stopwords">
      <label>Custom Stopwords (comma separated)</label>
      <prefix>custom_stopwords="</prefix>
      <suffix>"</suffix>
      <default></default>
    </input>
    <html>
      <p/>
      <p/>
      <p>
        <b>TFIDF Options</b>
      </p>
    </html>
    <input type="text" token="max_features">
      <label>Max Features</label>
      <default>1000</default>
      <initialValue>1000</initialValue>
    </input>
    <input type="dropdown" token="ngram">
      <label>TFIDF n-gram range</label>
      <choice value="1-1">1-1</choice>
      <choice value="1-2">1-2</choice>
      <choice value="1-3">1-3</choice>
      <choice value="1-4">1-4</choice>
      <default>1-1</default>
    </input>
    <html>
      <p>
        <b>Topic Modeling Options</b>
      </p>
    </html>
    <input type="dropdown" token="topic_algo" rejects="$topic_hidden$" searchWhenChanged="false">
      <label>Topic Model Algorithm</label>
      <choice value="TruncatedSVD">TruncatedSVD</choice>
      <choice value="LatentDirichletAllocation">LatentDirichletAllocation</choice>
      <choice value="NMF">NMF</choice>
      <default>TruncatedSVD</default>
      <initialValue>TruncatedSVD</initialValue>
      <change>
        <condition value="TruncatedSVD">
          <set token="topic_model_apply">
            <![CDATA[| fit TruncatedSVD k=$topic_k$ $textfield$_* ]]>
          </set>
          <set token="featurefield">SVD</set>
        </condition>
        <condition value="LatentDirichletAllocation">
          <set token="topic_model_apply">
            <![CDATA[| fit LatentDirichletAllocation k=$topic_k$ $textfield$_* ]]>
          </set>
          <set token="featurefield">LDA</set>
        </condition>
        <condition value="NMF">
          <set token="topic_model_apply">
            <![CDATA[| fit NMF k=$topic_k$ $textfield$_* ]]>
          </set>
          <set token="featurefield">NMF</set>
        </condition>
      </change>
    </input>
    <input type="text" token="topic_k" rejects="$topic_hidden$">
      <label>#Topic Components</label>
      <default>100</default>
      <initialValue>100</initialValue>
    </input>
    <html>
      <p>
        <b>Clustering Options</b>
      </p>
    </html>
    <input type="dropdown" token="cluster_algo">
      <label>Cluster Algorithm</label>
      <choice value="KMeans">KMeans</choice>
      <choice value="Birch">Birch</choice>
      <choice value="SpectralClustering">SpectralClustering</choice>
      <choice value="DBSCAN">DBSCAN</choice>
      <choice value="XMeans">XMeans</choice>
      <default>KMeans</default>
      <initialValue>KMeans</initialValue>
      <change>
        <condition value="KMeans">
          <unset token="k_hidden"></unset>
        </condition>
        <condition value="Birch">
          <unset token="k_hidden"></unset>
        </condition>
        <condition value="SpectralClustering">
          <unset token="k_hidden"></unset>
        </condition>
        <condition value="DBSCAN">
          <set token="k_hidden">true</set>
          <set token="clusters"></set>
        </condition>
        <condition value="XMeans">
          <set token="k_hidden">true</set>
          <set token="clusters"></set>
        </condition>
      </change>
    </input>
    <input type="text" token="clusters" rejects="$k_hidden$">
      <label># of Clusters</label>
      <default>7</default>
      <prefix>k=</prefix>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Top Terms Per Cluster</title>
      <input type="dropdown" token="topterms" searchWhenChanged="true">
        <label>Term Count</label>
        <choice value="2">2</choice>
        <choice value="5">5</choice>
        <choice value="10">10</choice>
        <choice value="20">20</choice>
        <choice value="30">30</choice>
        <choice value="40">40</choice>
        <default>10</default>
        <initialValue>10</initialValue>
      </input>
      <table id="tabledatabar">
        <search base="counts">
          <query>| eventstats count($textfield$) AS documentCount BY cluster
| where clusterCount &lt;= $topterms$
| stats values($textfield$) AS terms values(documentCount) AS documentCount BY cluster
| eventstats sum(documentCount) as total
| eval documentProportion = documentCount/total * 100
| table terms cluster documentProportion documentCount
| eval terms = mvjoin(terms, " ")</query>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <input type="dropdown" token="trellis_size" searchWhenChanged="true">
        <label>Trellis Size</label>
        <choice value="small">Small</choice>
        <choice value="medium">Medium</choice>
        <choice value="large">Large</choice>
        <default>large</default>
        <initialValue>large</initialValue>
        <change>
          <condition value="small">
            <set token="trellis_height">250</set>
          </condition>
          <condition value="medium">
            <set token="trellis_height">500</set>
          </condition>
          <condition value="large">
            <set token="trellis_height">1000</set>
          </condition>
        </change>
      </input>
      <chart>
        <search base="counts">
          <query>
| where clusterCount &lt;= $topterms$
| fields - clusterCount
          </query>
        </search>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.chart">bar</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">none</option>
        <option name="height">$trellis_height$</option>
        <option name="trellis.enabled">1</option>
        <option name="trellis.size">$trellis_size$</option>
        <option name="trellis.splitBy">cluster</option>
      </chart>
    </panel>
  </row>
</form>
